<?xml version="1.0" encoding="UTF-8"?>
<databaseChangeLog
        xmlns="http://www.liquibase.org/xml/ns/dbchangelog"
        xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance"
        xsi:schemaLocation="http://www.liquibase.org/xml/ns/dbchangelog
                      http://www.liquibase.org/xml/ns/dbchangelog/dbchangelog-4.6.xsd">

    <changeSet id="create_locations_table" author="dany">
        <createTable tableName="locations">
            <column name="id" type="SERIAL" autoIncrement="true">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="name" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="region" type="VARCHAR(100)"/>
            <column name="country" type="VARCHAR(100)">
                <constraints nullable="false"/>
            </column>
            <column name="latitude" type="DECIMAL(9,6)"/>
            <column name="longitude" type="DECIMAL(9,6)"/>
            <column name="timezone" type="VARCHAR(50)"/>
        </createTable>
    </changeSet>

    <changeSet id="create_weather_conditions_table" author="dany">
        <createTable tableName="weather_conditions">
            <column name="code" type="INTEGER">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="daytime_icon" type="VARCHAR(255)"/>
            <column name="nighttime_icon" type="VARCHAR(255)"/>
            <column name="description" type="TEXT">
                <constraints nullable="false"/>
            </column>
        </createTable>
    </changeSet>

    <changeSet id="create_forecast_days_table" author="dany">
        <createTable tableName="forecast_days">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="location_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="date" type="DATE">
                <constraints nullable="false"/>
            </column>
            <column name="date_epoch" type="BIGINT"/>

            <column name="sunrise" type="TIME"/>
            <column name="sunset" type="TIME"/>
            <column name="moonrise" type="TIME"/>
            <column name="moonset" type="TIME"/>
            <column name="moon_phase" type="VARCHAR(50)"/>
            <column name="moon_illumination" type="INTEGER"/>

            <column name="maxtemp_c" type="DECIMAL(5,2)"/>
            <column name="mintemp_c" type="DECIMAL(5,2)"/>
            <column name="avgtemp_c" type="DECIMAL(5,2)"/>
            <column name="maxwind_kph" type="DECIMAL(5,2)"/>
            <column name="totalprecip_mm" type="DECIMAL(5,2)"/>
            <column name="avgvis_km" type="DECIMAL(5,2)"/>
            <column name="avghumidity" type="INTEGER"/>
            <column name="daily_will_it_rain" type="BOOLEAN"/>
            <column name="daily_chance_of_rain" type="INTEGER"/>
            <column name="uv_index" type="DECIMAL(4,2)"/>

            <column name="aqi_us_epa_index" type="INTEGER"/>
            <column name="aqi_gb_defra_index" type="INTEGER"/>

            <column name="created_at" type="TIMESTAMP" defaultValueComputed="NOW()"/>
            <column name="updated_at" type="TIMESTAMP" defaultValueComputed="NOW()"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="forecast_days"
                baseColumnNames="location_id"
                referencedTableName="locations"
                referencedColumnNames="id"
                constraintName="fk_forecast_days_locations"
                onDelete="CASCADE"/>
        <addUniqueConstraint
                tableName="forecast_days"
                columnNames="location_id, date"
                constraintName="uq_forecast_days_location_date"/>
    </changeSet>

    <changeSet id="create_hourly_forecasts_table" author="dany">
        <createTable tableName="hourly_forecasts">
            <column name="id" type="SERIAL">
                <constraints primaryKey="true" nullable="false"/>
            </column>
            <column name="forecast_day_id" type="INTEGER">
                <constraints nullable="false"/>
            </column>
            <column name="time" type="TIMESTAMP">
                <constraints nullable="false"/>
            </column>
            <column name="time_epoch" type="BIGINT"/>

            <column name="temp_c" type="DECIMAL(5,2)"/>
            <column name="is_day" type="BOOLEAN"/>
            <column name="wind_kph" type="DECIMAL(5,2)"/>
            <column name="wind_degree" type="INTEGER"/>
            <column name="wind_dir" type="VARCHAR(3)"/>
            <column name="pressure_mb" type="DECIMAL(7,2)"/>
            <column name="precip_mm" type="DECIMAL(5,2)"/>
            <column name="humidity" type="INTEGER"/>
            <column name="cloud" type="INTEGER"/>
            <column name="feelslike_c" type="DECIMAL(5,2)"/>
            <column name="will_it_rain" type="BOOLEAN"/>
            <column name="chance_of_rain" type="INTEGER"/>
            <column name="visibility_km" type="DECIMAL(5,2)"/>

            <column name="aqi_co" type="DECIMAL(8,2)"/>
            <column name="aqi_no2" type="DECIMAL(8,2)"/>
            <column name="aqi_o3" type="DECIMAL(8,2)"/>
            <column name="aqi_so2" type="DECIMAL(8,2)"/>
            <column name="aqi_pm2_5" type="DECIMAL(8,2)"/>
            <column name="aqi_pm10" type="DECIMAL(8,2)"/>
        </createTable>

        <addForeignKeyConstraint
                baseTableName="hourly_forecasts"
                baseColumnNames="forecast_day_id"
                referencedTableName="forecast_days"
                referencedColumnNames="id"
                constraintName="fk_hourly_forecasts_forecast_days"
                onDelete="CASCADE"/>

        <addUniqueConstraint
                tableName="hourly_forecasts"
                columnNames="forecast_day_id, time"
                constraintName="uq_hourly_forecasts_day_time"/>
    </changeSet>

    <changeSet id="create_indexes" author="dany">
        <createIndex
                tableName="forecast_days"
                indexName="idx_forecast_days_location"
        >
            <column name="location_id"/>
        </createIndex>

        <createIndex
                tableName="forecast_days"
                indexName="idx_forecast_days_date"
        >
            <column name="date"/>
        </createIndex>

        <createIndex
                tableName="hourly_forecasts"
                indexName="idx_hourly_forecasts_time"
        >
            <column name="time"/>
        </createIndex>
    </changeSet>
</databaseChangeLog>